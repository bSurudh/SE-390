<DOCTYPE html>
<html>
    <head>
        <title>My Pictures</title>
        <!-- Bootstrap Core CSS -->
        <link href="css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="css/landing-page.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

        <!--<script type="text/javascript">
            if(document.cookie.indexOf('id_token') == -1) {
                window.location = "https://bsurudh.github.io";
            }
        </script>-->
        <style>
            .table-header-cell {
                text-align:center !important;
            }

            .table-cell {
                text-align:center !important;
                vertical-align:middle !important;
            }
        </style>
    </head>

    <body>
        <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top topnav" role="navigation">
        <div class="container topnav">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand topnav" href="/index.html">GeoPix</a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/map.html">Map</a>
                    </li>
                    <li>
                        <a href="/addfriends.html">Add Friends</a>
                    </li>
                    <li>
                        <a href="/mypictures.html">My Pictures</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <div class="container">
      <h2>.</h2>
      <h2>My Pictures</h2>
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="table-header-cell">Picture</th>
            <th class="table-header-cell">Timestamp</th>
            <th class="table-header-cell">Rating</th>
            <th class="table-header-cell"></th>
          </tr>
        </thead>
        <tbody id="picturesTableBody">
        </tbody>
    </div>

    <script src="js/jquery.js"></script>
    <script>
      function getCookie(cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i = 0; i <ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length,c.length);
            }
        }
        return "";
      }
      
      var imagesURL = "https://geopix-bengineering.rhcloud.com/images/user";
      var userID = getCookie("id_token");
      var photos = "";
      var picturesTableBody = document.getElementById("picturesTableBody");
      jQuery.ajax({
            url: imagesURL,
            type: "GET",
            dataType: "JSON",
            beforeSend: function(xhr) {
                xhr.setRequestHeader("authorization", "Bearer: " + userID);
            },
            success: function(data) {
                console.log(JSON.parse(JSON.stringify(data)));
                var baseURL = "https://geopix-bengineering.rhcloud.com/images/";
                for(var i = 0; i < data.length; i++) {
                    var curImage = data[i];
                    if(!curImage.hasOwnProperty("rating") || !curImage.hasOwnProperty("_id") || !curImage.hasOwnProperty("timestamp")) {
                        continue;
                    }
                    var imageRating = curImage["rating"];
                    var imageId = curImage["_id"];
                    var imageDate = new Date(curImage["timestamp"]);
                    var dateDisplayStr = imageDate.toDateString() + " " + imageDate.toLocaleTimeString();
                    var newRow = picturesTableBody.insertRow(0);
                    var pictureCell = newRow.insertCell(0);
                    var timestampCell = newRow.insertCell(1);
                    var ratingCell = newRow.insertCell(2);
                    var buttonCell = newRow.insertCell(3);
                    
                    var pictureImage = new Image(150, 200);
                    pictureImage.src = baseURL + imageId;
                    var deleteButton = document.createElement("BUTTON");
                    deleteButton.className = "btn btn-primary";
                    deleteButton.type = "button";
                    deleteButton.innerHTML = "Delete";
                    console.log("Creating event listener for image number: " + i + " out of " + data.length + " images. With id: " + imageId);
                    deleteButton.addEventListener("click", (function(innerImageId) { return function() {
                        console.log("Deleting image with id: " + innerImageId);
                        makeDeleteRequest(innerImageId);
                    } })(imageId), false);

                    pictureCell.appendChild(pictureImage);
                    pictureCell.className = "table-cell";
                    timestampCell.innerHTML = dateDisplayStr;
                    timestampCell.className = "table-cell";
                    ratingCell.innerHTML = imageRating;
                    ratingCell.className = "table-cell";
                    buttonCell.appendChild(deleteButton);
                    buttonCell.className = "table-cell";
                }
            },
            error: function(e,t) {
                console.log("AJAX friends request failed: " + t + " " + e);
            }
        });

        function makeDeleteRequest(imageId) {
            console.log("Deleting picture: " + imageId);
            var userID = getCookie("id_token");
            jQuery.ajax({
                url: "https://geopix-bengineering.rhcloud.com/images/" + imageId,
                type: "DELETE",
                beforeSend: function(xhr) {
                    xhr.setRequestHeader("authorization", "Bearer: " + userID);
                },
                success: function(data) {
                    location.reload(true);
                },
                error: function(e,t, m) {
                    console.log("AJAX delete picture request failed: " + t + " " + e + " " + m);
                }
            });
        }
    </script>
    </body>
</html>
>
</html>
